<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="/vue.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/naive-ui@2.34.3/dist/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sprintf-js@1.1.2/src/sprintf.min.js"></script>
  <title>Document</title>
  <style>
    a:-webkit-any-link {
      color: unset;
      text-decoration: none;
    }
    .price-up .price,
    .change-up .percent,
    .open-up .name,
    .open-up .open-percent,
    .open-up .open-price,
    .low-up .low-percent,
    .low-up .low-price,
    .high-up .high-percent,
    .high-up .high-price {
      color: red;
    }
    .price-down .price,
    .change-down .percent,
    .open-down .name,
    .open-down .open-percent,
    .open-down .open-price,
    .low-down .low-percent,
    .low-down .low-price,
    .high-down .high-percent,
    .high-down .high-price {
      color: green;
    }
    .price, .percent {
      font-size: 1.2em;
      font-weight: bold;
    }
    .row {
      transition: .3s;
    }
    .row td {
      font-style: italic;
      transition: .5s ease-in-out!important;
    }
    .price-up.row td {
      background-color: rgba(255,0,0,.1);
    }
    .price-down.row td {
      background-color: rgba(0,255,0,.1);
    }
    .price-equal.row td {
      /* background-color: rgba(0,0,0,.1); */
    }
  </style>
</head>
<body>
  <div id="app">
    <n-select
      remote
      clearable
      filterable
      placeholder="搜索证券"
      :clear-filter-after-select="false"
      :options="selectOptions"
      :loading="loadingSearch"
      @search="handleSearch"
      @input="handleSelectInput"
    ></n-select>
    <n-data-table
      bordered
      :columns="columns"
      :data="rows"
      :row-class-name="getRowClassName"
      :single-line="false"
      :row-props="handleRowProps"
      ></n-data-table>
      <n-dropdown
        placement="bottom-start"
        trigger="manual"
        :x="cursor[0]"
        :y="cursor[1]"
        :options="dropdownOptions"
        :on-clickOutside="() => shownDropdown = false"
        :show="shownDropdown"
        @select="handleClickContextmenu"
      ></n-dropdown>
  </div>
</body>

<script>
  const { createApp, createVNode, nextTick } = Vue
  function h(comp, options, children) {
    if (typeof options === 'function') {
      children = { default: options }
      options = null
    }
    return createVNode(naive[comp] || comp, options, children)
  }
  function sign(number) {
    number = `${number}`
    return !number.startsWith('-') ? '+' + number : number
  }
  function compare(v1, v2) {
    return v1 > v2 ? 1 : v1 < v2 ? -1 : 0
  }
  function percentText(v, base) {
    if (base) v = (v - base) / base
    return sign((v * 100).toFixed(2)) + '%'
  }
  function arr2obj(arr, key) {
    const obj = {}
    for (const e of arr) {
      obj[e[key]] = e
    } return obj
  }
  const app = createApp({
    data() {
      return {
        ws: null,
        loadingSearch: false,
        selectOptions: [],
        message: 'naive',
        symbols: [
          'sh000001',
          'sh600352',
          'sz002671',
          'sh603706',
          'sh512480',
        ],
        oldData: null,
        data: null,
        columns: [
          { key: 'symbol', className: 'symbol', title: '代码', render(rowData) { return rowData.symbol.toUpperCase() } },
          { key: 'name', className: 'name', title: '证券', render(rowData) {
            return h('a', {
              href: `https://www.xueqiu.com/S/${rowData.symbol}`,
              target: 'blank',
            }, rowData.name)
          } },
          { key: 'percent_', className: 'percent_', align: 'center', title: '涨幅', children: [
            { key: 'openPercent', className: 'open-percent', title: '开盘' },
            { key: 'lowPercent', className: 'low-percent', title: '最低' },
            { key: 'percent', className: 'percent', title: '当前', defaultSortOrder: 'descend' },
            { key: 'highPercent', className: 'high-percent', title: '最高' },
          ] },
          { key: 'price_', className: 'price_', align: 'center', title: '价格', children: [
            { key: 'open', className: 'open-price', title: '开盘' },
            { key: 'low', className: 'low-price', title: '最低' },
            { key: 'price', className: 'price', title: '当前' },
            { key: 'high', className: 'high-price', title: '最高' },
          ] },
          { key: 'time', className: 'time', title: '时间', },
          { key: 'action', className: 'action', title: '操作', render(rowData) {
            return h('NButton', { type: 'error' }, () => '删除')
          } },
        ],
        dropdownOptions: [
          { label: '编辑', key: 'edit' },
          { label: '删除', key: 'delete' }
        ],
        shownDropdown: false,
        cursor: [0, 0],
        row: null,
      }
    },
    computed: {
      rows() {
        return this.data ? this.symbols.map(symbol => this.data[symbol]) : []
      },
    },
    methods: {
      createWs() {
        const ws = this.ws = new WebSocket(`ws://${location.host}/ws`)
        window.ws = ws
        ws.onclose = () => {
          console.log('close')
          setTimeout(() => this.createWs(), 3000)
        }
        ws.onopen = () => {
          console.log('open')
          ws.send(JSON.stringify({type: 'begin', action: 'quote', data: { symbol: this.symbols }}))
        }
        ws.onmessage = (msg) => {
          const data = JSON.parse(msg.data)
          data.forEach(e => {
            e.current = e.price
            e.ratio = (e.price - e.close) / e.price
            e.percent = percentText(e.ratio)
            e.openPercent = percentText(e.open, e.close)
            e.lowPercent = percentText(e.low, e.close)
            e.highPercent = percentText(e.high, e.close)
          })
          this.data = arr2obj(data, 'symbol')
        }
      },
      getRowClassName(rowData) {
        const cls = ['row']
        cls.push(['high-down', 'high-equal', 'high-up'][compare(rowData.high, rowData.close) + 1])
        cls.push(['low-down', 'low-equal', 'low-up'][compare(rowData.low, rowData.close) + 1])
        cls.push(['open-down', 'open-equal', 'open-up'][compare(rowData.open, rowData.close) + 1])
        cls.push(['change-down', 'change-equal', 'change-up'][compare(rowData.price, rowData.close) + 1])
        cls.push(['price-down', 'price-equal', 'price-up'][compare(rowData.price, this.oldData?.[rowData.symbol]?.price) + 1])
        return cls.join(' ')
      },
      handleRowProps(row) {
        return {
          onContextmenu: e => {
            e.preventDefault()
            this.row = row
            this.shownDropdown = false
            nextTick().then(() => {
              this.shownDropdown = true
              this.cursor = [e.clientX, e.clientY]
            })
          },
        }
      },
      handleClickContextmenu(key) {
        if (key === 'delete') {
          if (this.row) this.symbols = this.symbols.filter(e => e !== this.row.symbol)
        }
        this.shownDropdown = false
      },
      handleSelectInput(v) {
        !this.symbols.includes(v) && this.symbols.push(v)
      },
      async handleSearch(q) {
        this.loadingSearch = true
        try {
          const res = await fetch(`/s/search?q=${q}`).then(res => res.json())
          this.selectOptions = res.map(e => ({
            label: e.name,
            value: e.symbol,
          }))
        } finally {
          this.loadingSearch = false
        }
      },
    },
    watch: {
      data(val, oldVal) {
        this.oldData = oldVal
      },
      symbols: {
        deep: true,
        handler(val) {
          localStorage.setItem('quote:symbols', JSON.stringify(this.symbols))
          this.ws && this.ws.readyState === this.ws.OPEN && this.ws.send(JSON.stringify({type: 'begin', action: 'quote', data: { symbol: this.symbols }}))
        },
      },
    },
    mounted() {
      this.createWs()
      const symbols = JSON.parse(localStorage.getItem('quote:symbols'))
      if (symbols) this.symbols = symbols
    },
  })
  app.use(naive)
  app.mount('#app')
</script>
</html>
